<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediRecord â€” Health Portal</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#f0f9ff;color:#1e293b;min-height:100vh}
.topbar{background:linear-gradient(135deg,#0284c7,#38bdf8);color:#fff;padding:0 2rem;height:60px;display:flex;align-items:center;justify-content:space-between}
.topbar h1{font-size:1.125rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
.topbar h1 svg{width:24px;height:24px}
.container{max-width:800px;margin:2rem auto;padding:0 1.5rem}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06);padding:1.5rem;margin-bottom:1rem;border:1px solid #bae6fd}
.card h2{font-size:1rem;font-weight:600;color:#0369a1;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.card h2 svg{width:18px;height:18px;color:#0ea5e9}
table{width:100%;border-collapse:collapse;font-size:0.875rem}
table th{text-align:left;padding:0.625rem;color:#64748b;border-bottom:2px solid #e0f2fe;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em}
table td{padding:0.625rem;border-bottom:1px solid #f0f9ff}
.status{padding:0.125rem 0.5rem;border-radius:999px;font-size:0.6875rem;font-weight:600}
.status-admitted{background:#dbeafe;color:#1d4ed8}
.status-observation{background:#fef3c7;color:#92400e}
.status-discharged{background:#d1fae5;color:#065f46}
.form-row{margin-bottom:1rem}
.form-row label{display:block;font-size:0.8125rem;font-weight:500;color:#475569;margin-bottom:0.375rem}
.form-row input{width:100%;padding:0.625rem;border:1.5px solid #bae6fd;border-radius:8px;font-size:0.875rem;font-family:inherit}
.form-row input:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,0.15)}
.btn{padding:0.625rem 1.25rem;border:none;border-radius:8px;font-size:0.875rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s}
.btn-blue{background:#0ea5e9;color:#fff;width:100%}.btn-blue:hover{background:#0284c7}
.btn-sm{padding:0.375rem 0.75rem;font-size:0.75rem}
.btn-danger{background:#ef4444;color:#fff}
.btn-outline{background:transparent;border:1.5px solid #bae6fd;color:#0369a1;font-size:0.8125rem;cursor:pointer;font-family:inherit;padding:0.5rem 1rem;border-radius:8px}
.alert{padding:0.75rem;border-radius:8px;font-size:0.8125rem;margin-bottom:1rem;display:none}
.alert-error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}.alert-success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
.login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0c4a6e,#0284c7)}
.login-card{background:#fff;border-radius:16px;padding:2.5rem;max-width:400px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
.login-card h1{text-align:center;font-size:1.375rem;margin-bottom:0.25rem}
.login-card p{text-align:center;color:#64748b;font-size:0.875rem;margin-bottom:2rem}
.login-card .logo{text-align:center;margin-bottom:1.5rem}
.login-card .logo svg{width:48px;height:48px}
.hidden{display:none!important}
.flag-banner{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:1rem;border-radius:12px;margin-bottom:1rem;font-family:monospace;font-size:0.875rem;word-break:break-all}
.flag-banner strong{display:block;margin-bottom:0.25rem;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;opacity:0.8}
.tabs{display:flex;gap:0.5rem;margin-bottom:1.5rem}
.tab{padding:0.5rem 1rem;border-radius:8px;font-size:0.8125rem;font-weight:500;cursor:pointer;background:#f0f9ff;color:#0369a1;border:1px solid #bae6fd;font-family:inherit}
.tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
</style>
</head>
<body>
<div id="loginView" class="login-wrapper">
  <div class="login-card">
    <div class="logo"><svg viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="14" fill="#0284c7"/><path d="M20 16h8v16h-8z" fill="none" stroke="#fff" stroke-width="2"/><path d="M16 24h16" stroke="#fff" stroke-width="2"/><path d="M24 20v8" stroke="#fff" stroke-width="2"/></svg></div>
    <h1>MediRecord</h1>
    <p>Health Records Portal</p>
    <div id="loginAlert" class="alert"></div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('login')">Sign In</button>
      <button class="tab" onclick="showTab('reset')">Reset Password</button>
    </div>

    <form id="loginForm">
      <div class="form-row"><label>Username</label><input type="text" id="username" required></div>
      <div class="form-row"><label>Password</label><input type="password" id="password" required></div>
      <button type="submit" class="btn btn-blue">Sign In</button>
    </form>

    <form id="resetRequestForm" class="hidden">
      <div class="form-row"><label>Email Address</label><input type="email" id="resetEmail" placeholder="user@medirecord.local" required></div>
      <button type="submit" class="btn btn-blue">Request Reset</button>
    </form>

    <form id="resetForm" class="hidden" style="margin-top:1rem;">
      <div class="form-row"><label>Reset Token</label><input type="text" id="resetToken" placeholder="Paste token here" required></div>
      <div class="form-row"><label>New Password</label><input type="password" id="newPassword" required></div>
      <button type="submit" class="btn btn-blue">Reset Password</button>
    </form>
  </div>
</div>

<div id="appView" class="hidden">
  <div class="topbar">
    <h1><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v6m0-6h10m-10 6H3m6 0h12M3 9v10a2 2 0 0 0 2 2h4m-6-12v10m6 2H3m6 0h10a2 2 0 0 0 2-2V9m-12 12V9"/></svg> MediRecord</h1>
    <div>
      <span style="color:rgba(255,255,255,0.8);font-size:0.8125rem;" id="userRole">Nurse</span>
      <button class="btn btn-danger btn-sm" style="margin-left:0.5rem" onclick="doLogout()">Logout</button>
    </div>
  </div>
  <div class="container">
    <div id="flagBanner"></div>
    <div class="card">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6m3-3h-6"/></svg> Patient Records</h2>
      <table><thead><tr><th>Patient ID</th><th>Name</th><th>Age</th><th>Ward</th><th>Status</th></tr></thead><tbody id="patientsBody"></tbody></table>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);

function showTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'?i===0:i===1)));
  $('#loginForm').classList.toggle('hidden', tab!=='login');
  $('#resetRequestForm').classList.toggle('hidden', tab==='login');
  if (tab==='login') $('#resetForm').classList.add('hidden');
  $('#loginAlert').style.display='none';
}

$('#loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const res = await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:$('#username').value,password:$('#password').value})});
  const d = await res.json();
  if (!res.ok) {$('#loginAlert').className='alert alert-error';$('#loginAlert').textContent=d.error;$('#loginAlert').style.display='block';return;}
  $('#loginView').classList.add('hidden');$('#appView').classList.remove('hidden');
  $('#userRole').textContent = d.user.role;
  loadData(d.user.role);
});

$('#resetRequestForm').addEventListener('submit', async e => {
  e.preventDefault();
  const res = await fetch('/api/auth/reset-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:$('#resetEmail').value})});
  const d = await res.json();
  $('#loginAlert').className='alert alert-success';$('#loginAlert').textContent=d.message;$('#loginAlert').style.display='block';
  $('#resetForm').classList.remove('hidden');
});

$('#resetForm').addEventListener('submit', async e => {
  e.preventDefault();
  const res = await fetch('/api/auth/reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:$('#resetToken').value,newPassword:$('#newPassword').value})});
  const d = await res.json();
  if (!res.ok) {$('#loginAlert').className='alert alert-error';$('#loginAlert').textContent=d.error;$('#loginAlert').style.display='block';return;}
  $('#loginAlert').className='alert alert-success';$('#loginAlert').textContent=d.message;$('#loginAlert').style.display='block';
  showTab('login');
});

async function loadData(role) {
  const patRes = await fetch('/api/patients');
  const patData = await patRes.json();
  $('#patientsBody').innerHTML = patData.patients.map(p =>
    `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.age}</td><td>${p.ward}</td><td><span class="status status-${p.status}">${p.status}</span></td></tr>`
  ).join('');

  if (role === 'admin') {
    const dashRes = await fetch('/api/admin/dashboard');
    if (dashRes.ok) {
      const dashData = await dashRes.json();
      if (dashData.dashboard.flag) {
        $('#flagBanner').innerHTML = `<div class="flag-banner"><strong>Flag Captured</strong>${dashData.dashboard.flag}</div>`;
      }
    }
  }
}

function doLogout() { fetch('/api/auth/logout',{method:'POST'}).then(()=>{$('#appView').classList.add('hidden');$('#loginView').classList.remove('hidden');$('#loginAlert').style.display='none';}); }
</script>
</body>
</html>

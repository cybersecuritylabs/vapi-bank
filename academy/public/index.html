<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V-API-Bank Academy — Dashboard</title>
  <link rel="stylesheet" href="/css/academy.css">
</head>
<body>
<div class="app-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <svg class="logo-icon" viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="12" fill="#2563eb"/><path d="M14 16h20v3H14zM14 22h16v3H14zM14 28h12v3H14z" fill="#fff" opacity="0.9"/><path d="M30 26a6 6 0 1 1 0 12 6 6 0 0 1 0-12z" fill="#fff"/><path d="M28 32h4M30 30v4" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round"/></svg>
      <div><h2>V-API-Bank</h2><span>Academy</span></div>
    </div>
    <nav class="sidebar-nav">
      <a href="/index.html" class="nav-item active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="/certificate.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        Certificate
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-details">
          <div class="user-name" id="userName">User</div>
          <div class="user-email" id="userEmail">user@example.com</div>
        </div>
        <button class="btn-logout" onclick="logout()" title="Sign out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <div class="page-header">
      <h1>Dashboard</h1>
      <p>Track your progress across all API security labs</p>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
        </div>
        <div class="stat-value" id="statTotal">10</div>
        <div class="stat-label">Total Labs</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div class="stat-value" id="statCompleted">0</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        </div>
        <div class="stat-value" id="statProgress">0%</div>
        <div class="stat-label">Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <div class="stat-value" id="statNext">1</div>
        <div class="stat-label">Current Lab</div>
      </div>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-bar-wrapper">
      <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
    </div>

    <!-- LABS -->
    <div class="section-header">
      <h2>Security Labs</h2>
    </div>
    <div class="labs-grid" id="labsGrid">
      <div class="loading"><div class="spinner"></div> Loading labs...</div>
    </div>
  </main>
</div>

<script>
const API = '';
const token = localStorage.getItem('vbank_token');
const user = JSON.parse(localStorage.getItem('vbank_user') || '{}');

if (!token) window.location.href = '/login.html';

document.getElementById('userName').textContent = user.username || 'User';
document.getElementById('userEmail').textContent = user.email || '';
document.getElementById('userAvatar').textContent = (user.username || 'U')[0].toUpperCase();

function logout() {
  localStorage.removeItem('vbank_token');
  localStorage.removeItem('vbank_user');
  window.location.href = '/login.html';
}

async function loadDashboard() {
  try {
    const res = await fetch(`${API}/api/labs`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.status === 401) { logout(); return; }
    const data = await res.json();

    document.getElementById('statTotal').textContent = data.totalCount;
    document.getElementById('statCompleted').textContent = data.completedCount;
    const pct = Math.round((data.completedCount / data.totalCount) * 100);
    document.getElementById('statProgress').textContent = pct + '%';
    document.getElementById('progressBar').style.width = pct + '%';

    const nextLab = data.labs.find(l => l.status !== 'completed' && l.unlocked);
    document.getElementById('statNext').textContent = nextLab ? nextLab.id : '✓';

    const grid = document.getElementById('labsGrid');
    grid.innerHTML = data.labs.map(lab => {
      const isCompleted = lab.status === 'completed';
      const isLocked = !lab.unlocked;
      const cardClass = isCompleted ? 'completed' : isLocked ? 'locked' : '';
      const diffClass = lab.difficulty.includes('Advanced') ? 'badge-advanced' : 'badge-intermediate';

      let statusHtml;
      if (isCompleted) {
        statusHtml = `<span class="card-status status-completed"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Completed</span>`;
      } else if (isLocked) {
        statusHtml = `<span class="card-status status-locked"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Locked</span>`;
      } else {
        statusHtml = `<span class="card-status status-available"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg> Available</span>`;
      }

      const actionBtn = isLocked
        ? ''
        : `<a href="/lab.html?id=${lab.id}" class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" style="font-size:0.8125rem;padding:0.5rem 1rem;">
            ${isCompleted ? 'Review' : 'Start Lab'}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="9 18 15 12 9 6"/></svg>
           </a>`;

      return `
        <div class="lab-card ${cardClass}" ${!isLocked ? `onclick="if(!event.target.closest('a'))window.location='/lab.html?id=${lab.id}'" style="cursor:pointer"` : ''}>
          <div class="card-top">
            <span class="lab-number">Lab ${String(lab.id).padStart(2,'0')}</span>
            <span class="badge ${diffClass}">${lab.difficulty}</span>
          </div>
          <h3>${lab.title}</h3>
          <div class="app-name">${lab.appName}</div>
          <div class="card-meta">
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> ${lab.category}</span>
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${lab.estimatedTime}</span>
          </div>
          <div class="card-action">
            ${statusHtml}
            ${actionBtn}
          </div>
        </div>`;
    }).join('');
  } catch (err) {
    console.error(err);
    document.getElementById('labsGrid').innerHTML = '<p style="color:var(--danger)">Failed to load labs. Please refresh.</p>';
  }
}

loadDashboard();
</script>
</body>
</html>

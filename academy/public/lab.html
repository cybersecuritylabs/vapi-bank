<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V-API-Bank Academy — Lab</title>
  <link rel="stylesheet" href="/css/academy.css">
</head>
<body>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-header">
      <svg class="logo-icon" viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="12" fill="#2563eb"/><path d="M14 16h20v3H14zM14 22h16v3H14zM14 28h12v3H14z" fill="#fff" opacity="0.9"/><path d="M30 26a6 6 0 1 1 0 12 6 6 0 0 1 0-12z" fill="#fff"/><path d="M28 32h4M30 30v4" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round"/></svg>
      <div><h2>V-API-Bank</h2><span>Academy</span></div>
    </div>
    <nav class="sidebar-nav">
      <a href="/index.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="/certificate.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        Certificate
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-details">
          <div class="user-name" id="userName">User</div>
          <div class="user-email" id="userEmail">user@example.com</div>
        </div>
        <button class="btn-logout" onclick="logout()" title="Sign out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <main class="main-content" id="labContent">
    <div class="loading"><div class="spinner"></div> Loading lab details...</div>
  </main>
</div>

<script>
const API = '';
const token = localStorage.getItem('vbank_token');
const user = JSON.parse(localStorage.getItem('vbank_user') || '{}');
if (!token) window.location.href = '/login.html';

document.getElementById('userName').textContent = user.username || 'User';
document.getElementById('userEmail').textContent = user.email || '';
document.getElementById('userAvatar').textContent = (user.username || 'U')[0].toUpperCase();

function logout() {
  localStorage.removeItem('vbank_token');
  localStorage.removeItem('vbank_user');
  window.location.href = '/login.html';
}

const labId = new URLSearchParams(window.location.search).get('id');
if (!labId) window.location.href = '/index.html';

async function loadLab() {
  try {
    const res = await fetch(`${API}/api/labs/${labId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.status === 401) { logout(); return; }
    if (res.status === 403) {
      document.getElementById('labContent').innerHTML = `
        <div class="breadcrumb">
          <a href="/index.html">Dashboard</a>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
          <span>Lab Locked</span>
        </div>
        <div class="cert-not-eligible">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <h2>Lab Locked</h2>
          <p>Complete the previous labs to unlock this one.</p>
          <a href="/index.html" class="btn btn-primary mt-2">Back to Dashboard</a>
        </div>`;
      return;
    }
    const lab = await res.json();
    renderLab(lab);
  } catch (err) {
    console.error(err);
    document.getElementById('labContent').innerHTML = '<p style="color:var(--danger);padding:2rem;">Failed to load lab.</p>';
  }
}

function renderLab(lab) {
  const isCompleted = lab.status === 'completed';
  const diffClass = lab.difficulty.includes('Advanced') ? 'badge-advanced' : 'badge-intermediate';
  const labUrl = `http://localhost:${lab.port}`;

  document.getElementById('labContent').innerHTML = `
    <div class="breadcrumb">
      <a href="/index.html">Dashboard</a>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      <span>Lab ${String(lab.id).padStart(2,'0')}</span>
    </div>

    <div class="lab-detail-header">
      <h1>${lab.title}</h1>
      <div class="meta-row">
        <span class="badge ${diffClass}">${lab.difficulty}</span>
        <span class="meta-tag">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          ${lab.category}
        </span>
        <span class="meta-tag">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          ${lab.estimatedTime}
        </span>
        <span class="meta-tag">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          ${lab.appName}
        </span>
        ${isCompleted ? '<span class="badge badge-completed">Completed</span>' : ''}
      </div>
    </div>

    <!-- Target App -->
    <div class="content-section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
        Target Application
      </h2>
      <p>${lab.description}</p>
      <div class="mt-2">
        <div class="credentials-box">Credentials: <strong>${lab.credentials}</strong></div>
      </div>
      <div class="launch-section mt-2">
        <a href="${labUrl}" target="_blank" rel="noopener" class="btn btn-primary btn-lg">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Launch Lab
        </a>
        <span class="meta-tag" style="font-size:0.8125rem;">Opens at ${labUrl}</span>
      </div>
    </div>

    <!-- Objective -->
    <div class="content-section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Objective
      </h2>
      <p>${lab.objective}</p>
    </div>

    <!-- Hints -->
    <div class="content-section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Hints (Progressive)
      </h2>
      <ul class="hints-list">
        ${lab.hints.map((h, i) => `
          <li class="hint-item">
            <button class="hint-toggle" onclick="this.parentElement.classList.toggle('open')">
              <span>Hint ${i + 1}</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
            <div class="hint-content"><p>${h}</p></div>
          </li>`).join('')}
      </ul>
    </div>

    <!-- Submit Flag -->
    <div class="content-section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
        Submit Flag
      </h2>
      <div id="submitAlert" class="alert" style="display:none"></div>
      ${isCompleted
        ? '<p style="color:var(--success);font-weight:600;">You have already completed this lab. Well done!</p>'
        : `<form class="submit-form" id="flagForm">
            <div class="form-group">
              <label for="flagInput">Enter the flag you discovered</label>
              <input type="text" id="flagInput" placeholder="VBANK{...}" required>
            </div>
            <button type="submit" class="btn btn-success btn-lg">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              Submit
            </button>
          </form>`}
    </div>`;

  if (!isCompleted) {
    document.getElementById('flagForm').addEventListener('submit', submitFlag);
  }
}

async function submitFlag(e) {
  e.preventDefault();
  const flag = document.getElementById('flagInput').value;
  const alertBox = document.getElementById('submitAlert');

  try {
    const res = await fetch(`${API}/api/labs/${labId}/submit`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ flag }),
    });
    const data = await res.json();
    if (!res.ok) {
      alertBox.className = 'alert alert-error';
      alertBox.textContent = data.error;
      alertBox.style.display = 'block';
      return;
    }
    alertBox.className = 'alert alert-success';
    alertBox.textContent = data.message + (data.nextLabUnlocked ? ' Next lab unlocked!' : '');
    alertBox.style.display = 'block';
    if (data.allCompleted) {
      alertBox.textContent += ' All labs completed — claim your certificate!';
    }
    setTimeout(() => loadLab(), 1500);
  } catch (err) {
    alertBox.className = 'alert alert-error';
    alertBox.textContent = 'Submission failed. Try again.';
    alertBox.style.display = 'block';
  }
}

loadLab();
</script>
</body>
</html>
